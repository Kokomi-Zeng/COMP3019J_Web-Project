{% extends "base_personInfo.html" %}

{#
页面需要参数：
phone:当前用户phone（String）,<<<若未登录返回None></若未登录返回None></若未登录返回None></若未登录返回None>
name:当前用户name
#}

{#title应放入base中#}
{% block title %}
{{ name }}的个人界面
{% endblock %}

{% block nav_bar %}
    <button class="nav-button" id="info">info</button>
    <button class="nav-button" id="charge">charge</button>
    <button class="nav-button" id="purchased">purchased</button>
{% endblock %}

{% block script %}
    <script>

    let container = $(".container");

    window.onload = function (){
        $("#info").click(function (){
            info();
        })
        $("#charge").click(function (){
            charge();
        })
        $("#purchased").click(function (){
            purchased();
        })
        $("#log_out").click(function (){
            log_out();
        })
    }
    function info(){
        {#清除dom#}
        container.empty();

        $.ajax({
            url:"/buyer/buyerInfo",
            type:"get",
            contentType: "application/json",
            dataType: "json",
            data: {phone:phone},
            success:function (data){

                const name_div = document.createElement("div");
                const name_label = document.createElement("label")
                const name_input = document.createElement("input");

                name_div.setAttribute("class", "info-div");
                name_div.setAttribute("id", "name-div");

                name_label.innerText = "Name: "

                name_input.setAttribute("type", "text");
                name_input.setAttribute("value", data.name);
                name_input.setAttribute("id", "name");

                name_div.append(name_label);
                name_label.append(name_input)
                container.append(name_div);

                const phone_div = document.createElement("div");
                const phone_label = document.createElement("label")
                const phone_input = document.createElement("input");

                phone_div.setAttribute("class", "info-div");
                phone_div.setAttribute("id", "phone-div");

                phone_label.innerText = "Phone: ";

                phone_input.setAttribute("type", "text");
                phone_input.setAttribute("value", data.phone);
                phone_input.setAttribute("id", "phone");

                phone_div.append(phone_label);
                phone_label.append(phone_input)
                container.append(phone_div);

                const introduction_div = document.createElement("div");
                const introduction_label = document.createElement("label")
                const introduction_input = document.createElement("input");

                introduction_div.setAttribute("class", "info-div");
                introduction_div.setAttribute("id", "introduction-div");

                introduction_label.innerText = "Introduction: ";

                introduction_input.setAttribute("type", "text");
                introduction_input.setAttribute("value", data.introduction);
                introduction_input.setAttribute("id", "introduction");

                introduction_div.append(introduction_label);
                introduction_label.append(introduction_input);
                container.append(introduction_div);


                const password_div = document.createElement("div");
                const password_label = document.createElement("label")
                const password_input = document.createElement("input");

                password_div.setAttribute("class", "info-div");
                password_div.setAttribute("id", "password-div");

                password_label.innerText = "Password: ";

                password_input.setAttribute("type", "text");
                password_input.setAttribute("id", "password");

                password_div.append(password_label);
                password_label.append(password_input);
                container.append(password_div);

                const submit_div = document.createElement("div");
                submit_div.onclick = function (){
                    $.ajax({
                        url:'/modifyBuyerInfo',
                        type:'get',
                        contentType: "application/json",
                        dataType: "json",
                        data:{
                            phone:phone,
                            name:$("#name").val(),
                            password:$("#password").val(),
                            introduction:$("#introduction").val(),
                        },
                        success:function (data){
                            info()
                        }
                    })
                }
                container.append(submit_div);
            }
        })


    }
    function charge(){
        {#清除dom#}
        container.empty();

        $.ajax({
            url:"/buyer/getMoney",
            type:"get",
            contentType: "application/json",
            dataType: "json",
            data:{
                phone:phone,
            },
            success:function (data){
                const current = data.money;
                const current_div = document.createElement("div");
                const current_span = document.createElement("span");

                current_div.setAttribute("class", "charge-div");
                current_div.setAttribute("id", "current-div");

                current_span.innerText = "Current: "+current;
                current_div.append(current_span);
                container.append(current_div);

                const pay_div = document.createElement("div");
                const pay_input = document.createElement("input");

                pay_div.setAttribute("class", "charge-div");
                pay_div.setAttribute("id", "pay-div");

                pay_input.setAttribute("id", "pay");
                pay_input.setAttribute("type", "text");
                pay_input.setAttribute("placeHolder", "pay number");

                pay_div.append(pay_input);
                container.append(pay_div);

                const password_div = document.createElement("div");
                const password_input = document.createElement("input");

                password_div.setAttribute("class", "charge-div");
                password_div.setAttribute("id", "password-div");

                password_input.setAttribute("type", "password");
                password_input.setAttribute("id", "password");
                password_input.setAttribute("placeHolder", "password");

                password_div.append(password_input);
                container.append(password_div);

                const submit_div = document.createElement("div");
                const submit_button = document.createElement("button");

                submit_button.innerText = "Purchased!"
                submit_button.onclick = function (){
                    $.ajax({
                        url:'/buyer/charge',
                        type:'get',
                        contentType: "application/json",
                        dataType: "json",
                        data:{
                            phone:phone,
                            password:$("#password").val(),
                            charge_num:$("#pay").val(),
                        },
                        success:function (data){
                            if (data.success==="success"){
                                charge();
                            }else {
                                alert(data.message)
                            }
                        }
                    })
                }
                submit_div.append(submit_button);
                container.append(submit_div);
            }
        })
    }
    function purchased(){
        {#清除dom#}
        container.empty();

        $.ajax({
            url:"/buyer/buyerItem",
            type:"get",
            contentType: "application/json",
            dataType: "json",
            data:{
                phone:phone,
            },
            success:function (data){
                for (let i = 0; i<data.length; i++) {
                    const item = data[i];

                    const item_div = document.createElement("div");
                    item_div.setAttribute("class", "item-box");
                    container.append(item_div);

                    const item_img_div = document.createElement("div");
                    const item_img = document.createElement("img");

                    item_img_div.setAttribute("class", "item-img-box");
                    item_img.setAttribute("src", item.image_src);

                    item_img_div.append(item_img);
                    item_div.append(item_img_div);

                    const item_name_div = document.createElement("div");
                    const item_name = document.createElement("span");

                    item_name_div.setAttribute("class", "item-name-box");
                    item_name.innerText = item.product_name;

                    item_name_div.append(item_name);
                    item_div.append(item_name_div);

                    const item_quantity_div = document.createElement("div");
                    const item_quantity = document.createElement("span");

                    item_quantity_div.setAttribute("class", "item-quantity-box");
                    item_quantity.innerText = item.purchase_quantity;

                    item_quantity_div.append(item_quantity);
                    item_div.append(item_quantity_div);

                    const item_time_div = document.createElement("div");
                    const item_time = document.createElement("span");

                    item_time_div.setAttribute("class", "item-time-box");
                    item_time.innerText = item.purchase_time;

                    item_time_div.append(item_time);
                    item_div.append(item_time_div);

                    const item_price_div = document.createElement("div");
                    const item_price = document.createElement("span");

                    item_price_div.setAttribute("class", "item-price-box");
                    item_price.innerText = item.total_price;

                    item_price_div.append(item_price);
                    item_div.append(item_price_div);
                }

            }
        })
    }

    </script>
{% endblock %}

{% block body %}
<div class="container"></div>
{% endblock %}