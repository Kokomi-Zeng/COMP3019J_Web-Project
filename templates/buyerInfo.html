{#
    This HTML file is page for buyer to check and modify their information.
    User can also charge money and inspect purchased items in this page.
    It has such funtions:
    1. get_session (Extends)
    1. log_out (Extends)
    2. get_and_render_user_info
    3. get_and_render_money
    4. render_money
    5. charge
    6. get_and_render_purchased_items
    7. render_purchased_items

    Using js:
    1. alert.js (Extends)
    2. get_user_image.js (Extends)
    3. render_user_info.js (Extends)

    JS functions:
    1. get_user_image (Extends)
    2. alert_message (Extends)
    3. render_user_info (Extends)
#}
{% extends "base_personInfo.html" %}

{% block nav_bar %}
    <button class="nav-button" id="info" onclick="get_and_render_buyer_info()">info</button>
    <button class="nav-button" id="charge" onclick="get_and_render_money()">charge</button>
    <button class="nav-button" id="purchased" onclick="get_and_render_purchased_items()">purchased</button>
{% endblock %}

{% block script %}

    <script>
    let container;

    {#when session is loaded#}
    $(document).on("sessionLoaded", function () {

        container = $(".container");

        {#set title#}
        {% block title %}
        name + "'s account"
        {% endblock %}

        {#default to get and render buyer information#}
        get_and_render_buyer_info();
    });

    {#This method is to get and render buyer information#}
    function get_and_render_buyer_info(){
        $.ajax({
            url:"/buyer/buyerInfo",
            type: 'get',
            contentType: "application/json",
            dataType: "json",
            data:{
                phone: phone
            },
            success:function (data){
                render_user_info(data)
            }
        })
    }

    {#This method is to get and render buyer's money information#}
    function get_and_render_money() {
        $.ajax({
            url: "/buyer/getMoney",
            type: "get",
            contentType: "application/json",
            dataType: "json",
            data: {
                phone: phone,
            },
            success: function (data) {
                render_money(data);
            }
        })
    }

    {#This method is to render buyer's money information#}
    function render_money(data){

        {#clear DOM#}
        container.empty();

        {#Render SPAN current money#}
        const current = data.money;
        const current_div = document.createElement("div");
        const current_span = document.createElement("span");
    
        current_div.setAttribute("class", "charge-div");
        current_div.setAttribute("id", "current-div");
        current_span.innerText = "Current: "+current;

        current_div.append(current_span);
        container.append(current_div);

        {#Render INPUT NUMBER current money#}
        const pay_div = document.createElement("div");
        const pay_input = document.createElement("input");
    
        pay_div.setAttribute("class", "charge-div");
        pay_div.setAttribute("id", "pay-div");
        pay_input.setAttribute("id", "pay");
        pay_input.setAttribute("type", "number");
        pay_input.setAttribute("placeHolder", "pay number");
    
        pay_div.append(pay_input);
        container.append(pay_div);

        {#Render INPUT PASSWORD password#}
        const password_div = document.createElement("div");
        const password_input = document.createElement("input");
    
        password_div.setAttribute("class", "charge-div");
        password_div.setAttribute("id", "password-div");
        password_input.setAttribute("type", "password");
        password_input.setAttribute("id", "password");
        password_input.setAttribute("placeHolder", "password");
    
        password_div.append(password_input);
        container.append(password_div);

        {#Render BUTTON purchase#}
        const submit_div = document.createElement("div");
        const submit_button = document.createElement("button");
    
        submit_button.innerText = "Purchase!"
        submit_button.onclick = function (){
            charge(password_input.value, pay_input.value);
        }
        submit_div.append(submit_button);
        container.append(submit_div);
    }

    {#This method is to charge money#}
    function charge(password, pay){
        $.ajax({
            url:'/buyer/charge',
            type:'get',
            contentType: "application/json",
            dataType: "json",
            data:{
                phone:phone,
                password:password,
                charge_num:pay,
            },
            success:function (data){
                alert(data.message)
                if (data.success) {

                    {#Charge success, get and render money again#}
                    get_and_render_money();
                }
            }
        })
    }

    {#This function is to get and render purchased items#}
    function get_and_render_purchased_items(){
        $.ajax({
            url:"/buyer/buyerItem",
            type:"get",
            contentType: "application/json",
            dataType: "json",
            data:{
                phone:phone,
            },
            success:function (data){
                render_purchased_items(data)
            }
        })
    }

    {#This function is to render purchased items with ajax response#}
    function render_purchased_items(data){

        {#clear DOM#}
        container.empty();

        for (let i = 0; i<data.length; i++) {
            {#get each item#}
            const item = data[i];

            {#Render DIV item container#}
            const item_div = document.createElement("div");
            item_div.setAttribute("class", "item-box");
            container.append(item_div);

            const item_img_div = document.createElement("div");
            const item_img = document.createElement("img");

            item_img_div.setAttribute("class", "item-img-box");
            item_img.setAttribute("src", item.image_src);

            item_img_div.append(item_img);
            item_div.append(item_img_div);

            {#Render SPAN item name#}
            const item_name_div = document.createElement("div");
            const item_name = document.createElement("span");

            item_name_div.setAttribute("class", "item-name-box");
            item_name.innerText = item.product_name;

            item_name_div.append(item_name);
            item_div.append(item_name_div);

            {#Render SPAN item quantity#}
            const item_quantity_div = document.createElement("div");
            const item_quantity = document.createElement("span");

            item_quantity_div.setAttribute("class", "item-quantity-box");
            item_quantity.innerText = item.purchase_quantity;

            item_quantity_div.append(item_quantity);
            item_div.append(item_quantity_div);

            {#Render SPAN purchased time#}
            const item_time_div = document.createElement("div");
            const item_time = document.createElement("span");

            item_time_div.setAttribute("class", "item-time-box");
            item_time.innerText = item.purchase_time;

            item_time_div.append(item_time);
            item_div.append(item_time_div);

            {#Render SPAN total price#}
            const item_price_div = document.createElement("div");
            const item_price = document.createElement("span");

            item_price_div.setAttribute("class", "item-price-box");
            item_price.innerText = item.total_price;

            item_price_div.append(item_price);
            item_div.append(item_price_div);
        }
    }

    </script>
{% endblock %}

{% block body %}
<div class="container"></div>
{% endblock %}