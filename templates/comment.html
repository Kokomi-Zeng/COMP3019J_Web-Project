{#
    This HTML file is page for users who have already logged in to inspect comment.
    Buyers can also upload their comments.
    It has such funtions:
    1. get_session (Extends)
    2. get_and_render_comment
    3. render_next_page_button
    4. render_prev_page_button
    5. get_and_render_prev_page
    6. get_and_render_next_page
    7. render_self_comment_box
    8. create_comment

    Using js:
    1. alert.js (Extends)
    2. get_user_image.js (Extends)
    3. render_comment.js
    4. is_item_match_seller.js

    JS functions:
    1. get_user_image (Extends)
    2. alert_message (Extends)
    3. render_comment
    4. is_item_match_seller
#}
{% extends "base.html" %}

{% block css %}
    <link rel="stylesheet" href="/static/css/comment.css">
{% endblock %}

{% block script %}
    <script src="/static/js/render_comment.js"></script>
    <script src="/static/js/is_item_match_seller.js"></script>
    <script>
    let page_num = 1;
    let belong;

    {#when session is loaded#}
    $(document).on("sessionLoaded", function() {
        is_item_match_seller("{{ product_id }}")

        {#when belong is loaded#}
        $(document).on("belongLoaded", function () {

            get_and_render_comment();

            if (type==="1"){
                render_self_comment_box();
            } else if (type==="0" && !belong) {
                window.location.href = document.referrer;
            }
            console.log(belong)
        })
    })

    {#This function is to get and render comment#}
    function get_and_render_comment(){

        $(".comment-box").empty();
        $.ajax({
            url:"/comment/commentInfoById",
            type:"get",
            contentType: "application/json",
            dataType: "json",
            data:{
                product_id:"{{ product_id }}",
                phone:phone,
            },
            success:function(data){
                render_comment(data);

                {#Render BUTTON page button#}
                get_and_render_prev_page();
                get_and_render_next_page();
            }
        })
    }

    {#This function is to render next page button#}
    function render_next_page_button() {
        const button = document.createElement("button");
        button.setAttribute("class", "page-button");
        button.innerText = "next";
        button.onclick = function () {
            page_num++;
            get_and_render_comment();
        }
        $(".next").append(button);
    }

    {#This function is to get and render next page button#}
    function get_and_render_next_page(){
        $.ajax({
            url:"/comment/hasNextComment",
            type:"get",
            contentType: "application/json",
            dataType: "json",
            data: {
                phone: phone,
                keyword: $("#search-box").val(),
                page_num: page_num,
            },
            success: function (data) {
                if (data.has_next) {
                    render_next_page_button(data)
                }
            }
        })
    }

    {#This function is to render prev page button#}
    function render_prev_page_button(){
        const button = document.createElement("button");
        button.setAttribute("class", "page-button");
        button.innerText = "prev";
        button.onclick = function () {
            page_num--;
            get_and_render_comment();
        }
        $(".prev").append(button);
    }

    {#This function is to get and render prev page button#}
    function get_and_render_prev_page(){
        if (page_num>1){
            render_prev_page_button()
        }
    }

    {#This function is to render self comment box#}
    function render_self_comment_box() {
        {#Render DIV container#}
        const self_comment_box = document.createElement("div");
        self_comment_box.setAttribute("class", "self-comment-box")

        $(".main").append(self_comment_box);


        {#Render INPUT NUMBER rating#}
        const self_rating_div = document.createElement("div");
        const self_rating = document.createElement("input");

        self_rating_div.setAttribute("class", "self-rating-box");
        self_rating.setAttribute("class", "self-rating");
        self_rating.setAttribute("placeHolder", "rating");
        self_rating.setAttribute("type", "number");

        self_comment_box.append(self_rating_div);
        self_rating_div.append(self_rating);


        {#Render TEXTAREA content#}
        const self_content_div = document.createElement("div");
        const self_content = document.createElement("textarea");

        self_content_div.setAttribute("class", "self-content-box");
        self_content.setAttribute("class", "self-content");
        self_content.setAttribute("placeHolder", "content");
        self_rating.setAttribute("type", "text");

        self_comment_box.append(self_content_div);
        self_content_div.append(self_content);

        {#Render BUTTON submit#}
        const self_content_button = document.createElement("button");

        self_content_button.setAttribute("id", "self-content-button");
        self_content_button.innerText = "Submit->"
        self_content_button.onclick = function () {
            create_comment(self_rating.value, self_content.value)
        }

        self_comment_box.append(self_content_button);

    }

    {#This function is to create comment#}
    function create_comment(rating, content){
        $.ajax({
            url: "/comment/createComment",
            type: "get",
            contentType: "application/json",
            dataType: "json",
            data: {
                buyer_phone:phone,
                product_id:"{{ product_id }}",
                rating:rating,
                content:content
            },
            success:function (data){
                if (data.success){
                    alert(data.message)
                    {#reload comment#}

                    get_and_render_comment();
                }else {
                    alert(data.message)
                }
            }
        })
    }

    </script>
{% endblock %}

{% block main %}
    <div class="comment-box">
    </div>
    <div class="prev"></div>
    <div class="next"></div>
{% endblock %}