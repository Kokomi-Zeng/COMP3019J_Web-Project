{#
    This HTML file is page for users to inspect items.
    Users can also search items by items' name.
    Seller can only inspect items they have.
    Buyer can inspect all items.
    None-login user can only inspect ten popular items.
    It has such funtions:
    1. get_session (Extends)
    2. get_and_render_item
    3. render_prev_page_button
    4. render_next_page_button
    5. get_and_render_prev_page
    6. get_and_rende_next_page
    7. render_item
    8. render_buyer
    9. render_seller

    Using js:
    1. alert.js (Extends)
    2. get_user_image.js (Extends)

    JS functions:
    1. get_user_image (Extends)
    2. alert_message (Extends)
#}
{% extends "base.html" %}

{#set title#}
{% block title %}
    Shop
{% endblock %}

{#link css#}
{% block css %}
    <link rel="stylesheet" href="/static/css/shop.css">
{% endblock %}

{% block script %}
    <script>

    let page_num = 1;

    {#when session is loaded#}
    $(document).on("sessionLoaded", function() {

        {#get and render item automatically#}
        get_and_render_item();

        if (type==="1" || type === "0"){
            render_search_box();

            get_and_render_next_button();
            get_and_render_prev_button();
            if (type==="0"){
                render_buyer();
            }else {
                render_seller();
            }
        }
    });

    /**
     * This function is to get and render items
     */
    function get_and_render_item(){

        {#clear DOM#}
        $(".item-box").empty();

        $.ajax({
            url: "/shop/searchItemByName",
            type: "get",
            contentType: "application/json",
            dataType: "json",
            data: {
                phone: phone,
                keyword: $("#search-box").val(),
                page_num: page_num,
            },
            success: function (data) {
                render_item(data);

                {#Render BUTTON page button#}
                get_and_render_next_button()
                get_and_render_prev_button();
            }
        })
    }

    /**
     * This function is to render BUTTON prev
     */
    function render_prev_page_button(){
            const button = document.createElement("button");
            button.setAttribute("class", "page-button");
            button.innerText = "prev";
            button.onclick = function () {
                page_num--;
                get_and_render_item();
            }
            $(".prev").append(button);
    }

    /**
     * This function is to render search box for buyer account
     */
    function render_search_box(){
        const search_input = document.createElement("input");

        search_input.setAttribute("id", "search-box");
        search_input.setAttribute("type", "text");
        search_input.setAttribute("placeholder", "Search");
        search_input.onkeyup = function (){
            get_and_render_item();
        }

        $(".search-box").append(search_input);
    }

    /**
     * This function is to get and render BUTTON prev
     */
    function get_and_render_prev_button(){

        {#clear DOM#}
        $(".prev").empty();

        if (page_num>1){
            render_prev_page_button()
        }
    }

    /**
     * This function is to render BUTTON next
     */
    function render_next_page_button() {
        const button = document.createElement("button");
        button.setAttribute("class", "page-button");
        button.innerText = "next";
        button.onclick = function () {
            page_num++;
            get_and_render_item();
        }
        $(".next").append(button);
    }

    /**
     * This function is to get and render BUTTON next
     */
    function get_and_render_next_button(){

        {#clear DOM#}
        $(".next").empty();

        $.ajax({
            url:"/shop/hasNextPage",
            type:"get",
            contentType: "application/json",
            dataType: "json",
            data: {
                phone: phone,
                keyword: $("#search-box").val(),
                page_num: page_num,
            },
            success: function (data) {
                if (data.has_next) {
                    render_next_page_button(data)
                }
            }
        })
    }

    /**
     * This method is to render Products depend on products data
     * @param data is JSON that contains items info
     */
    function render_item(data){

        for (let i=0; i<data.length; i++){
            {#get each item#}
            const item = data[i];


            {#Render DIV container #}
            const item_box = document.createElement("div");
            item_box.setAttribute("class", "item");


            {#Render BUTTON item jump button#}
            const item_button = document.createElement("button");

            item_button.setAttribute("class", "item-button")
            item_button.onclick = function (){
                window.location.href = "/item?product_id="+ item.product_id;
            }
            $(".item-box").append(item_box);
            item_box.append(item_button);


            {#Render IMG img#}
            const img_box = document.createElement("div");
            const img = document.createElement("img");

            img_box.setAttribute("class", "img-box");
            img.setAttribute("src", item.image_src);

            item_button.append(img_box);
            img_box.append(img);


            {#Rendder SPAN price#}
            const price_box = document.createElement("div");
            const price = document.createElement("span");

            img_box.setAttribute("class", "price-box");
            price.innerText = "Price: " + item.price;

            item_box.append(price_box);
            price_box.append(price);


            {#Render SPAN name#}
            const name_box = document.createElement("div");
            const name = document.createElement("span");

            img_box.setAttribute("class", "name-box");
            name.innerText = "Name: " + item.product_name;

            item_box.append(name_box);
            name_box.append(name);


            {#Render SPAN rating#}
            const rating_box = document.createElement("div");
            const rating = document.createElement("span");

            img_box.setAttribute("class", "rating-box");
            rating.innerText = "Rating: " + item.rating;

            item_box.append(rating_box);
            rating_box.append(rating);

        }
    }

    /**
     * This function is to render "add" button for seller account
     */
    function render_add_button(){
        const item_title_box = $(".item-title");

        const item_add_button = document.createElement("button", {
            class: "item-title-text",
            type:"button",
        })
        item_add_button.onclick = function (){
            window.location.href = "/sellerAdd"
        }
        item_add_button.innerText = "Product Management"
        item_title_box.append(item_add_button);
    }

    /**
     * This method is to render buyer components
     */
    function render_buyer(){
        const item_title_box = $(".item-title");

        const item_title_text = document.createElement("span", {
            class: "item-title-text"
        })
        item_title_text.innerText = "All Products:"
        item_title_box.append(item_title_text);
    }

    /**
     * This method is to render seller components
     */
    function render_seller(){
        const item_title_box = $(".item-title");

        const item_title_text = document.createElement("span", {
            class: "item-title-text"
        })
        item_title_text.innerText = "Product Management:"
        item_title_box.append(item_title_text);

        render_add_button();
    }
    </script>
{% endblock %}

{% block main %}
    <div class="item-title"></div>
    <div class="item-box"></div>
    <div class="prev"></div>
    <div class="next"></div>
{% endblock %}