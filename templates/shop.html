{% extends "base.html" %}
{#
需要参数：
用户名username
用户类型type
用户phone
#}
{% block script %}
    <script>

    let page_num;
    
    $(document).on("sessionLoaded", function() {

        console.log(111)
        page_num = 1;
        
        get_item();
        get_next_page();
        get_prev_page();

    });
    
    function get_item(){
        $.ajax({
            url: "/shop/searchItemByName",
            type: "get",
            contentType: "application/json",
            dataType: "json",
            data: {
                phone: phone,
                keyword: $("#search-box").val(),
                page_num: page_num,
            },
            success: function (data) {
                render_item(data)
            }
        })
    }

    function render_prev_page_button(){
            const button = document.createElement("button");
            button.setAttribute("class", "page-button");
            button.innerText = "prev";
            button.onclick = function () {
                page_num--;
                get_item();
            }
            $(".prev").append(button);
    }

    function get_prev_page(){
        if (page_num>1){
            render_prev_page_button()
        }
    }

    function render_next_page_button() {
        const button = document.createElement("button");
        button.setAttribute("class", "page-button");
        button.innerText = "next";
        button.onclick = function () {
            page_num++;
            get_item();
        }
        $(".next").append(button);
    }

    function get_next_page(){
        $.ajax({
            url:"/shop/hasNextPage",
            type:"get",
            contentType: "application/json",
            dataType: "json",
            data: {
                phone: phone,
                keyword: $("#search-box").val(),
                page_num: page_num,
            },
            success: function (data) {
                if (data.has_next) {
                    render_next_page_button(data)
                }
            }
        })
    }

    function render_item(data){

        $(".item-box").empty();
        $(".prev").empty();
        $(".next").empty();

        for (let i=0; i<data.length; i++){
            const item = data[i];

            const item_box = document.createElement("div");
            const item_button = document.createElement("button");

            item_box.setAttribute("class", "item");
            item_button.onclick = function (){
                window.location.href = "/item?product_id="+ item.product_id;
            }
            $(".item-box").append(item_box);
            item_box.append(item_button);

            const img_box = document.createElement("div");
            const img = document.createElement("img");

            img_box.setAttribute("class", "img-box");
            img.setAttribute("src", item.image_src);

            item_button.append(img_box);
            img_box.append(img);

            const price_box = document.createElement("div");
            const price = document.createElement("span");

            img_box.setAttribute("class", "price-box");
            price.innerText = item.price;

            item_button.append(price_box);
            price_box.append(price);

            const name_box = document.createElement("div");
            const name = document.createElement("span");

            img_box.setAttribute("class", "name-box");
            name.innerText = item.product_name;

            item_button.append(name_box);
            name_box.append(name);

            const rating_box = document.createElement("div");
            const rating = document.createElement("span");

            img_box.setAttribute("class", "rating-box");
            rating.innerText = item.rating;

            item_button.append(rating_box);
            rating_box.append(rating);

        }
    }
    </script>
{% endblock %}

{% block css %}
    /static/css/shop.css
{% endblock %}

{% block search_box %}
    <input type="search" id="search-box" placeholder="输入商品" onkeyup="generate()">
{% endblock %}

{% block main %}
    <div class="item-box">
    </div>
    <div class="prev"></div>
    <div class="next"></div>
{% endblock %}