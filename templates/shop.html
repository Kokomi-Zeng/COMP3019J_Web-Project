{#
    This HTML file is page for users to inspect items.
    Users can also search items by items' name.
    Seller can only inspect items they have.
    Buyer can inspect all items.
    None-login user can only inspect ten popular items.
    It has such funtions:
    1. get_session (Extends)
    2. get_and_render_item
    3. render_prev_page_button
    4. render_next_page_button
    5. get_and_render_prev_page
    6. get_and_rende_next_page
    7. render_item

    Using js:
    1. alert.js (Extends)
    2. get_user_image.js (Extends)

    JS functions:
    1. get_user_image (Extends)
    2. alert_message (Extends)
#}
{% extends "base.html" %}

{#set title#}
{% block title %}
    Shop
{% endblock %}

{#link css#}
{% block css %}
    <link rel="stylesheet" href="/static/css/shop.css">
{% endblock %}

{% block script %}
    <script>

    let page_num = 1;

    {#when session is loaded#}
    $(document).on("sessionLoaded", function() {

        {#get and render item automatically#}
        get_and_render_item();
    });

    {#This function is to get and render items#}
    function get_and_render_item(){
        $.ajax({
            url: "/shop/searchItemByName",
            type: "get",
            contentType: "application/json",
            dataType: "json",
            data: {
                phone: phone,
                keyword: $("#search-box").val(),
                page_num: page_num,
            },
            success: function (data) {
                render_item(data)
            }
        })
    }

    {#This function is to render BUTTON prev#}
    function render_prev_page_button(){
            const button = document.createElement("button");
            button.setAttribute("class", "page-button");
            button.innerText = "prev";
            button.onclick = function () {
                page_num--;
                render_next_page_button();
            }
            $(".prev").append(button);
    }

    {#This function is to get and render BUTTON prev#}
    function get_and_render_prev_button(){
        if (page_num>1){
            render_prev_page_button()
        }
    }

    {#This function is to render BUTTON next#}
    function render_next_page_button() {
        const button = document.createElement("button");
        button.setAttribute("class", "page-button");
        button.innerText = "next";
        button.onclick = function () {
            page_num++;
            get_and_render_item();
        }
        $(".next").append(button);
    }

    {#This function is to get and render BUTTON next#}
    function get_and_render_next_button(){
        $.ajax({
            url:"/shop/hasNextPage",
            type:"get",
            contentType: "application/json",
            dataType: "json",
            data: {
                phone: phone,
                keyword: $("#search-box").val(),
                page_num: page_num,
            },
            success: function (data) {
                if (data.has_next) {
                    render_next_page_button(data)
                }
            }
        })
    }

    function render_item(data){

        {#clear DOM#}
        $(".item-box").empty();
        $(".prev").empty();
        $(".next").empty();
        get_and_render_next_button()
        get_and_render_prev_button();


        for (let i=0; i<data.length; i++){
            const item = data[i];

            const item_box = document.createElement("div");
            const item_button = document.createElement("button");

            item_box.setAttribute("class", "item");
            item_button.setAttribute("class", "item-button")
            item_button.onclick = function (){
                window.location.href = "/item?product_id="+ item.product_id;
            }
            $(".item-box").append(item_box);
            item_box.append(item_button);

            const img_box = document.createElement("div");
            const img = document.createElement("img");

            img_box.setAttribute("class", "img-box");
            img.setAttribute("src", item.image_src);

            item_button.append(img_box);
            img_box.append(img);

            const price_box = document.createElement("div");
            const price = document.createElement("span");

            img_box.setAttribute("class", "price-box");
            price.innerText = "Price: " + item.price;

            item_box.append(price_box);
            price_box.append(price);

            const name_box = document.createElement("div");
            const name = document.createElement("span");

            img_box.setAttribute("class", "name-box");
            name.innerText = "Name: " + item.product_name;

            item_box.append(name_box);
            name_box.append(name);

            const rating_box = document.createElement("div");
            const rating = document.createElement("span");

            img_box.setAttribute("class", "rating-box");
            rating.innerText = "Rating: " + item.rating;

            item_box.append(rating_box);
            rating_box.append(rating);

        }
    }
    </script>
{% endblock %}

{% block search_box %}
    <input type="search" id="search-box" placeholder="search item by name" onkeyup="get_and_render_item()">
{% endblock %}

{% block main %}
    <div class="item-box">
    </div>
    <div class="prev"></div>
    <div class="next"></div>
{% endblock %}