{% extends "base.html" %}

{% block title %}
{{ product_id }}
{% endblock %}

{% block script %}
    <script src="/static/js/render_comment.js"></script>
    <script src="/static/js/render_self_comment_box.js"></script>
    <script>

    let belong;

    window.onload = function () {
        $(document).on("sessionLoaded", function () {

            {#页面渲染开始——————————————————————————————————————————————————————————————————————————————————————————#}
{#        判断belong关系#}
            is_item_match_seller()

            get_item_data();

            get_comment();

            {#buyer#}
            if (!belong) {
                render_buyer_box();

                render_comment();
            }

            {#buyer#}
        {#    页面渲染结束——————————————————————————————————————————————————————————————————————————————————————————#}
        });
    }

    function is_item_match_seller(){
        $.ajax({
            url:"/shop/isItemMatchSeller",
            type: "get",
            contentType: "application/json",
            dataType: "json",
            data:{
                product_id:"{{ product_id }}",
                phone: phone
            },
            success:function (data){
                belong = data.belong;
            }
        })
    }

    function get_item_data(){

        $(".img-box").empty();
        $(".item-name").empty();
        $(".item-rating").empty();
        $(".item-price").empty();
        $(".item-storage").empty();

        $.ajax({
            url: "/products/itemInfoById",
            type: "get",
            contentType: "application/json",
            dataType: "json",
            data: {
                product_id: "{{ product_id }}"
            },
            success: function (data) {
                render_item_data(data)
            }
        })
    }

    function render_item_data(data){
        let img;
        let name;
        let rating;
        let price;
        let storage
        {#buyer/visiter#}
        if (!belong) {

            img = document.createElement("img");
            name = document.createElement("span");
            rating = document.createElement("span");
            price = document.createElement("span");
            storage = document.createElement("span");

            img.setAttribute("src", data.src);
            name.innerText = data.name;
            rating.innerText = data.average_rating;
            price.innerText = data.price;
            storage.innerText = data.storage;
        }else {
            {#seller#}
            img = document.createElement("img");
            name = document.createElement("input");
            rating = document.createElement("input");
            price = document.createElement("input");
            storage = document.createElement("input");

            img.setAttribute("src", data.src);
            name.value = data.name;

            rating.setAttribute("type", "text")
            rating.value = data.average_rating;

            price.setAttribute("type", "text")
            price.value = data.price;

            storage.setAttribute("type", "text")
            storage.value = data.storage;

        }

        $(".img-box").append(img);name.setAttribute("type", "text")
        $(".item-name").append(name);
        $(".item-rating").append(rating);
        $(".item-price").append(price);
        $(".item-storage").append(storage);
    }

    function render_buyer_box() {
        const buy_num = document.createElement("input");
        buy_num.setAttribute("type", "num");
        buy_num.setAttribute("placeHolder", "buy number");
        buy_num.setAttribute("id", "buy-num");

        const buy_button = document.createElement("button");
        buy_button.setAttribute("id", "buy-button");
        buy_button.innerText = "BUY!";
        buy_button.onclick = function () {
            $.ajax({
                url: "/buyer/buyItem",
                type: "get",
                contentType: "application/json",
                dataType: "json",
                data: {
                    product_id: "{{ product_id }}",
                    phone: phone,
                    quantity: buy_num.value,
                },
                success: function (data) {
                    if (data.success) {
                        alert("success")
                    } else {
                        alert(data.error)
                    }
                    render_item_data()
                }
            })
        };
        const buy_box = $(".buy-box");
        buy_box.append(buy_num);
        buy_box.append(buy_button);
    }

    function get_comment(){
        $.ajax({
            url: "/comment/commentBasicInfoById",
            type: "get",
            contentType: "application/json",
            dataType: "json",
            data: {
                product_id: "{{ product_id }}"
            },
            success: function (data) {
                render_comment(data)
                render_more_comment_button()
            }
        })
    }

    function render_more_comment_button(){
        const more_comment_button_div = document.createElement("div");
        const more_comment_button = document.createElement("button");

        more_comment_button_div.setAttribute("class", "comment-text");
        more_comment_button.innerText = "More Comment";
        more_comment_button.onclick = function (){
            if (type==="1" || type==="0") {
                window.location.href = "/comment?product_id="+"{{ product_id }}";
            }else {
                window.location.href = "/login";
            }
        }

        more_comment_button_div.append(more_comment_button);
        $(".comment-box").append(more_comment_button_div);
    }
    </script>
{% endblock %}

{% block main %}
<div class="left-box">
    <div class="img-box"></div>
    <div class="message-box">
        <div class="item-name-box">
            <span>Name:</span>
            <div class="item-name"></div>
        </div>
        <div class="item-rating-box">
            <span>rating:</span>
            <div class="item-rating"></div>
        </div>
        <div class="item-price-box">
            <span>price:</span>
            <div class="item-price"></div>
        </div>
        <div class="item-storage-box">
            <span>storage:</span>
            <div class="item-storage"></div>
        </div>

    </div>
    <div class="operation-box">
        <div class="buy-operation">
            <div class="buy-box">
            </div>
        </div>
        <div>
            <div class="look-more-comment">
            </div>
        </div>
    </div>
</div>
<div class="right-box">
    <div class="comment-box"></div>
</div>

<div class="back-button-box">
    <button class="back-button" onclick="history.back()">Back</button>
</div>
{% endblock %}