{#
    This HTML file is page for users to inspect items in detail.
    This page will also show the highest five comments and lowest five comments.
    Buyers can buy the item in this page.
    Sellers can modify their items in this page.
    It has such funtions:
    1. get_session (Extends)
    2. get_and_render_item_data
    3. render_item_data
    4. render_prev_page_button
    5. render_buyer
    6. render_modify_button
    7. get_and_render_comment
    8. render_more_comment_button
    9. get_and_render_rating

    Using js:
    1. alert.js (Extends)
    2. get_user_image.js (Extends)
    3. render_comment.js
    4. is_item_match_seller.js

    JS functions:
    1. get_user_image (Extends)
    2. alert_message (Extends)
    3. render_comment
    4. is_item_match_seller
#}
{% extends "base.html" %}

{% block title %}
{{ product_id }}
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="/static/css/item.css">
{% endblock %}

{% block script %}
    <script src="/static/js/render_comment.js"></script>
    <script src="/static/js/render_item_info.js"></script>
    <script src="/static/js/is_item_match_seller.js"></script>
    <script>
    let belong;
    let product_id = "{{ product_id }}"
    let info_box;
    let rating_box;
    let comment_box;
    {#when session is loaded#}
    $(document).on("sessionLoaded", function () {
        info_box = $(".info-box")
        rating_box = $(".rating-box")
        comment_box = $(".comment-box")
        is_item_match_seller()
        $(document).on("belongLoaded", function () {

            // invalid account
            if (!belong && type === "0") {
                window.location.href = "/shop";
            }
            get_and_render_item_data();
            get_and_render_comment();
            {#buyer#}
            if (type === "1") {
                render_buyer();
            } else if (type === "0") {

                {#seller#}
                if (belong){
                    render_seller();
                }else {
                    window.location.href = "/shop"
                }
            }
        })
    });

    function get_and_render_item_data(){

        $.ajax({
            url: "/products/itemInfoById",
            type: "get",
            contentType: "application/json",
            dataType: "json",
            data: {
                product_id: "{{ product_id }}"
            },
            success: function (data) {
                render_item_info(data);
            }
        })
    }

    function render_buyer() {

        const operation_box = $(".operation-box");
        operation_box.empty();

        const buy_num = document.createElement("input");
        buy_num.setAttribute("type", "num");
        buy_num.setAttribute("placeHolder", "buy number");
        buy_num.setAttribute("id", "buy-num");

        const buy_button = document.createElement("button");
        buy_button.setAttribute("id", "buy-button");
        buy_button.innerText = "BUY";
        buy_button.onclick = function () {
            $.ajax({
                url: "/buyer/buyItem",
                type: "get",
                contentType: "application/json",
                dataType: "json",
                data: {
                    product_id: "{{ product_id }}",
                    phone: phone,
                    quantity: buy_num.value,
                },
                success: function (data) {
                    alert(data.message);
                    if (data.success) {
                        get_and_render_item_data();
                    }
                }
            })
        };
        operation_box.append(buy_num);
        operation_box.append(buy_button);
    }

    function render_seller(){
        const operation_box = $(".operation-box");
        operation_box.empty();
        //Delete BUTTON
        const delete_button_div = document.createElement("button", {
            class:"delete-button-box"
        })
        const delete_button = document.createElement("button", {
            class:"delete_button",
            type:"button"
        })
        delete_button.innerText = "Delete"
        delete_button.onclick = function (){
            $.ajax({
                url:"/products/deleteItem",
                type:"get",
                data:{product_id: product_id},
                success: function (data){
                    alert(data.message)
                    window.location.replace("/shop")
                }
            })
        }
        delete_button_div.append(delete_button);
        operation_box.append(delete_button_div)
    }

    function get_and_render_comment(){
        $.ajax({
            url: "/comment/commentBasicInfoById",
            type: "get",
            contentType: "application/json",
            dataType: "json",
            data: {
                product_id: "{{ product_id }}"
            },
            success: function (data) {
                render_comment(data)
                render_more_comment_button()
            }
        })
    }

    function render_more_comment_button() {
        const more_comment_button_div = document.createElement("div");
        const more_comment_button = document.createElement("button");

        more_comment_button_div.setAttribute("class", "comment-text");
        more_comment_button.innerText = "More Comment";
        more_comment_button.onclick = function () {
            if (type === "1" || type === "0") {
                window.location.href = "/comment?product_id=" + "{{ product_id }}";
            } else {
                window.location.href = "/login";
            }
        }

        more_comment_button_div.append(more_comment_button);
        $(".comment-box").append(more_comment_button_div);
    }
    </script>
{% endblock %}

{% block main %}
<div class="left-box">
    <div class="info-box"></div>
    <div class="operation-box"></div>
</div>
<div class="rating-box"></div>
<div class="comment-box"></div>

<div class="back-button-box">
    <button class="back-button" onclick="history.back()">Back</button>
</div>
{% endblock %}