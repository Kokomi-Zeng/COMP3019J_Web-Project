{#
    This HTML file is page for users to inspect items in detail.
    This page will also show the highest five comments and lowest five comments.
    Buyers can buy the item in this page.
    Sellers can modify their items in this page.
    It has such funtions:
    1. get_session (Extends)
    2. get_and_render_item_data
    3. render_item_data
    4. render_prev_page_button
    5. render_buyer_box
    6. render_modify_button
    7. get_and_render_comment
    8. render_more_comment_button
    9. get_and_render_rating

    Using js:
    1. alert.js (Extends)
    2. get_user_image.js (Extends)
    3. render_comment.js
    4. is_item_match_seller.js

    JS functions:
    1. get_user_image (Extends)
    2. alert_message (Extends)
    3. render_comment
    4. is_item_match_seller
#}
{% extends "base.html" %}

{% block title %}
{{ product_id }}
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="/static/css/item.css">
{% endblock %}

{% block script %}
    <script src="/static/js/render_comment.js"></script>
    <script src="/static/js/is_item_match_seller.js"></script>
    <script>
    let belong;

    {#when session is loaded#}
    $(document).on("sessionLoaded", function () {

        {##}
        is_item_match_seller("{{ product_id }}")
        $(document).on("belongLoaded", function () {

            if (!belong && type === "0") {
                window.location.href = "/shop";
            }

            get_and_render_item_data();
            get_and_render_comment();

            {#buyer#}
            if (type === "1") {
                render_buyer_box();
            } else if (type === "0") {

                {#seller#}
                if (belong){
                    window.location.href = "/shop"
                }else {
                    render_modify_button();
                }
            }
        })
    });

    function get_and_render_item_data(){

        $(".img-box").empty();
        $(".item-name-box").empty();
        $(".item-rating-box").empty();
        $(".item-price").empty();
        $(".item-storage").empty();

        $.ajax({
            url: "/products/itemInfoById",
            type: "get",
            contentType: "application/json",
            dataType: "json",
            data: {
                product_id: "{{ product_id }}"
            },
            success: function (data) {
                render_item_data(data);
                render_rating(data.average_rating);
            }
        })
    }

    function render_item_data(data){
        let img;
        let name;
        let description;
        let price;
        let storage
        {#buyer/visiter#}
        if (!belong) {

            img = document.createElement("img");
            name = document.createElement("span");
            description = document.createElement("span");
            price = document.createElement("span");
            storage = document.createElement("span");

            img.setAttribute("src", data.image_src);
            name.innerText ="Name: " + data.name;
            description.innerText ="description: " + data.description;
            price.innerText ="Price: " + data.price;
            storage.innerText ="Storage: " + data.storage;
        }else {
            {#seller#}
            img = document.createElement("img");
            name = document.createElement("input");
            description = document.createElement("input");
            price = document.createElement("input");
            storage = document.createElement("input");

            img.setAttribute("src", data.image_src);

            name.setAttribute("type", "text")
            name.value ="Name: " + data.name;

            description.setAttribute("type", "text")
            description.value ="description: " + data.description;

            price.setAttribute("type", "text")
            price.value ="Price: " + data.price;

            storage.setAttribute("type", "text")
            storage.value ="Storage: " + data.storage;

        }

        $(".img-box").append(img);
        $(".item-name-box").append(name);
        $(".item-description-box").append(description);
        $(".item-price-box").append(price);
        $(".item-storage-box").append(storage);
    }

    function render_buyer_box() {
        console.log(333)
        const buy_box = document.createElement("div");

        buy_box.setAttribute("class", "buy-box")

        $(".left-box").append(buy_box);
        
        const buy_num = document.createElement("input");
        buy_num.setAttribute("type", "num");
        buy_num.setAttribute("placeHolder", "buy number");
        buy_num.setAttribute("id", "buy-num");

        const buy_button = document.createElement("button");
        buy_button.setAttribute("id", "buy-button");
        buy_button.innerText = "BUY!";
        buy_button.onclick = function () {
            $.ajax({
                url: "/buyer/buyItem",
                type: "get",
                contentType: "application/json",
                dataType: "json",
                data: {
                    product_id: "{{ product_id }}",
                    phone: phone,
                    quantity: buy_num.value,
                },
                success: function (data) {
                    alert(data.message);
                    if (data.success) {
                        render_item_data();
                    }
                }
            })
        };
        buy_box.append(buy_num);
        buy_box.append(buy_button);
    }

    function render_modify_button(){

    }

    function get_and_render_comment(){
        $.ajax({
            url: "/comment/commentBasicInfoById",
            type: "get",
            contentType: "application/json",
            dataType: "json",
            data: {
                product_id: "{{ product_id }}"
            },
            success: function (data) {
                render_comment(data)
                render_more_comment_button()
            }
        })
    }

    function render_more_comment_button() {
        const more_comment_button_div = document.createElement("div");
        const more_comment_button = document.createElement("button");

        more_comment_button_div.setAttribute("class", "comment-text");
        more_comment_button.innerText = "More Comment";
        more_comment_button.onclick = function () {
            if (type === "1" || type === "0") {
                window.location.href = "/comment?product_id=" + "{{ product_id }}";
            } else {
                window.location.href = "/login";
            }
        }

        more_comment_button_div.append(more_comment_button);
        $(".comment-box").append(more_comment_button_div);
    }

    function render_rating(){
        const rating_box = $(".rating-box");
        rating_box.empty();

        const rating_text = document.createElement("span", {
            class: "rating-text"
        })
        rating_box.append(rating_text);
    }
    </script>
{% endblock %}

{% block main %}
<div class="left-box">
    <div class="img-box"></div>
    <div class="message-box">
        <div class="item-name-box">
        </div>
        <div class="item-description-box">
        </div>
        <div class="item-price-box">
        </div>
        <div class="item-storage-box">
        </div>
    </div>
</div>
<div class="rating-box"></div>
<div class="comment-box"></div>

<div class="back-button-box">
    <button class="back-button" onclick="history.back()">Back</button>
</div>
{% endblock %}